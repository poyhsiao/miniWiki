# 测试覆盖率改进计划

## 目标
将整体测试覆盖率从当前水平提升到 **80%**。

## 现状分析

### 测试文件结构
项目共有 **28个测试文件**：
- 单元测试：各服务模块的 `*_test.rs` 文件
- 集成测试：`tests/` 目录下的集成测试
- 示例测试：部分服务内的测试用例

### 当前测试覆盖情况
- ✅ **已覆盖**：
  - 基础CRUD操作（文档、用户、空间）
  - 认证和授权流程
  - 基础数据处理逻辑
  - 模型序列化/反序列化
  
- ❌ **覆盖率不足**：
  - 错误处理边界情况
  - 并发操作的竞态条件
  - 复杂业务逻辑分支
  - 集成场景的完整流程
  - 文件上传的边缘情况
  - WebSocket连接状态管理
  - 同步冲突的高级场景

### 覆盖率工具选择
根据最佳实践，选择 **`cargo-llvm-cov`** 作为覆盖率工具：
- ✅ 官方推荐
- ✅ 跨平台支持（Linux, macOS, Windows）
- ✅ 基于LLVM源码覆盖，准确度高
- ✅ 支持HTML/LCOV/JSON报告
- ✅ 与CI/CD集成良好

## 改进策略

### 1. 工具集成
- [x] 安装 `cargo-llvm-cov` 工具
- [x] 创建 GitHub Actions 工作流自动生成覆盖率报告
- [x] 配置覆盖率阈值检查（80%）
- [x] 生成覆盖率徽章并显示在 README 中

### 2. 补充测试用例

#### 2.1 错误处理测试
```rust
// 需要为以下错误情况添加测试：
- [ ] Invalid JWT token 格式
- [ ] Expired token 验证
- [ ] 数据库连接失败处理
- [ ] S3存储超时错误
- [ ] 文件上传大小限制
- [ ] 不支持的文件类型
- [ ] 并发冲突解决失败
- [ ] 缺少必需的请求头
```

#### 2.2 边界条件测试
```rust
// 需要为以下边界条件添加测试：
- [ ] 空字符串输入
- [ ] 最大长度限制（标题、内容等）
- [ ] 零值和负数输入
- [ ] 空文档/空间/用户 ID
- [ ] 超大文件大小限制
- [ ] 同时上传大量文件
- [ ] 快速连续的并发请求
```

#### 2.3 业务逻辑测试
```rust
// 需要为以下业务逻辑添加测试：
- [ ] 文档版本管理（创建、更新、删除、恢复）
- [ ] 空间配额管理
- [ ] 文件权限验证（读、写、删除、分享）
- [ ] WebSocket连接生命周期
- [ ] 同步冲突检测和自动合并
- [ ] 搜索查询的相关性排序
- [ ] 用户操作审计日志
```

#### 2.4 集成测试
```rust
// 需要为以下集成场景添加测试：
- [ ] 完整的文档创建和协作流程
- [ ] 多用户同时编辑同一文档
- [ ] 文件上传并关联到文档
- [ ] 版本恢复并验证内容
- [ ] 实时同步（WebSocket）多个客户端
- [ ] 冲突解决后的最终状态一致性
- [ ] 导出文档（Markdown/HTML）的完整性
```

### 3. 代码重构
```rust
// 提高可测试性的重构建议：
- [ ] 提取复杂条件分支为独立函数
- [ ] 使用 `Result` 类型代替 panic!（已有部分，需要全面推广）
- [ ] 减少嵌套的 if-else 语句
- [ ] 模块化大型函数（单个函数不超过 50 行）
- [ ] 使用依赖注入以便于测试
- [ ] 为副作用操作提供接口
```

### 4. 测试基础设施
```rust
// 测试工具和辅助函数：
- [ ] 创建统一的测试辅助函数（TestApp, ResponseValidator）
- [ ] 实现测试数据工厂（批量生成测试数据）
- [ ] 添加测试夹具（Fixtures）用于复杂数据准备
- [ ] 实现模拟外部依赖（Mock S3, Mock RDS）
- [ ] 创建性能基准测试套件
```

## 执行计划

### Phase 1: 工具设置（优先级：高）
1. 安装 `cargo-llvm-cov`
2. 创建 GitHub Actions 覆盖率工作流
3. 运行初始覆盖率报告并建立基线
4. 设置覆盖率阈值检查（80%）

### Phase 2: 核心模块改进（优先级：高）
1. 补充文档服务的错误处理测试
2. 补充认证服务的边界条件测试
3. 补充文件服务的文件类型验证测试
4. 补充同步服务的冲突解决测试

### Phase 3: 集成场景改进（优先级：中）
1. 添加完整文档生命周期集成测试
2. 添加多用户协作集成测试
3. 添加文件上传集成测试
4. 添加 WebSocket 实时同步集成测试

### Phase 4: 代码质量提升（优先级：中）
1. 重构复杂函数以提高可测试性
2. 统一错误处理模式
3. 优化测试用例的可维护性

### Phase 5: 验证和优化（优先级：高）
1. 运行完整覆盖率报告
2. 分析未覆盖的代码区域
3. 针对优先级补充测试
4. 持续监控覆盖率趋势
5. 设置定期覆盖率检查（每周）

## 成功指标
- [ ] 整体覆盖率 ≥ 80%
- [ ] 核心模块覆盖率 ≥ 85%
- [ ] 所有关键业务流程有集成测试覆盖
- [ ] 覆盖率报告可以定期生成
- [ ] 覆盖率徽章显示在 README 中

## 参考资源
- [cargo-llvm-cov 官方文档](https://github.com/taiki-e/cargo-llvm-cov)
- [Rust Book - 测试章节](https://doc.rust-lang.org/book/ch11-00-testing.html)
- [Rust by Example - 测试](https://doc.rust-lang.org/rust-by-example/testing.html)

## 下一步行动
1. 创建 GitHub Actions 工作流（已完成）
2. 推送并验证覆盖率工作流
3. 根据初始覆盖率报告确定优先级
4. 按照执行计划逐步补充测试
5. 定期审查覆盖率趋势并调整策略
