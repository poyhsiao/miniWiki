# Flutter App 問題修復總結

## 修復日期
2026-01-16

## 修復的問題

### 1. .flutter-plugins-dependencies 檔案問題
**問題**: 自動生成的檔案包含機器特定路徑,不應提交到版本控制
**修復**:
- 將 `.flutter-plugins-dependencies` 和 `.flutter-plugins` 加入 `.gitignore`
- 執行 `git rm --cached .flutter-plugins-dependencies` 從 git 索引中移除
- 檔案: `flutter_app/.gitignore`

### 2. DocumentEntity Isar 持久化問題
**問題**:
- `copyWith` 方法缺少 `id` 參數,導致複製的實體遺失 Isar 主鍵
- `Map<String, dynamic>? content` 欄位無法被 Isar 持久化

**修復**:
- 在 `copyWith` 方法加入 `int? id` 參數,確保主鍵被保留
- 將 `content` 改為計算屬性(getter/setter),實際儲存使用 `String? contentJson`
- 加入 `dart:convert` import 支援 JSON 序列化
- 更新序列化/反序列化邏輯使用 `contentJson` 欄位
- 檔案: `flutter_app/lib/data/models/document_entity.dart`

### 3. UserEntity copyWith 問題
**問題**: `copyWith` 方法缺少 `id` 參數,導致複製的實體遺失 Isar 主鍵
**修復**:
- 在 `copyWith` 方法加入 `int? id` 參數
- 在返回的實體上設定 `..id = id ?? this.id`
- 檔案: `flutter_app/lib/data/models/user_entity.dart`

### 4. IsarDatasource 錯誤處理問題
**問題**: `_deserializeDocument` 缺少對 JSON 解析和日期解析錯誤的處理
**修復**:
- 加入 try-catch 捕捉 `FormatException` 和 `TypeError`
- 在 `jsonDecode` 時驗證返回類型
- 建立 `parseDateTime` 輔助函數處理日期解析錯誤
- 所有錯誤訊息包含原始 JSON 和錯誤上下文
- 檔案: `flutter_app/lib/data/datasources/isar_datasource.dart`

### 5. SyncService 同步問題
**問題 A**: `syncDocument` 使用不一致的操作欄位名稱('op' vs 'operation'),且傳送內部元數據到後端
**修復**:
- 統一使用 'operation' 欄位,同時支援 'op' 以便安全遷移
- 建立 sanitizedData 移除 'op' 和 'operation' 內部元數據
- 確保 spaceId 從 sanitizedData 中提取

**問題 B**: 隊列項目同步失敗時未移除或移動到失敗隊列
**修復**:
- 在 `syncDocument` 的隊列項目分支加入 try-catch
- 失敗時呼叫 `removeFromQueue` 和 `addToFailedQueue`
- 與 `syncAllDirtyDocuments` 保持一致的錯誤處理
- 檔案: `flutter_app/lib/services/sync_service.dart`

## 測試結果
✅ `test/sync_service_test.dart` - 20 個測試全部通過
✅ `test/document_repository_test.dart` - 測試通過
✅ `test/document_service_test.dart` - 測試通過
✅ `test/auth_service_test.dart` - 測試通過

## 影響範圍
- 資料模型層 (DocumentEntity, UserEntity)
- 資料來源層 (IsarDatasource)
- 服務層 (SyncService)
- 版本控制設定 (.gitignore)

## 注意事項
1. DocumentEntity 的 `content` 現在是計算屬性,實際儲存在 `contentJson` 中
2. 所有使用 `copyWith` 的地方現在都會正確保留 Isar 主鍵
3. 同步服務現在會正確處理失敗的隊列項目
4. 內部元數據不再傳送到後端 API
